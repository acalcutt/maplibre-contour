!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).mlcontour=t()}(this,(function(){"use strict";var e,t,r;function i(i,n){if(e)if(t){var s="var sharedChunk = {}; ("+e+")(sharedChunk); ("+t+")(sharedChunk);",o={};e(o),r=n(o),"undefined"!=typeof window&&(r.workerUrl=window.URL.createObjectURL(new Blob([s],{type:"text/javascript"})))}else t=n;else e=n}return i(0,(function(e){class t{constructor(e,t){this.start=e,this.end=t,this.points=[],this.append=this.append.bind(this),this.prepend=this.prepend.bind(this)}append(e,t){this.points.push(Math.round(e),Math.round(t))}prepend(e,t){this.points.splice(0,0,Math.round(e),Math.round(t))}lineString(){return this.toArray()}isEmpty(){return this.points.length<2}appendFragment(e){this.points.push(...e.points),this.end=e.end}toArray(){return this.points}}const r=[[],[[[1,2],[0,1]]],[[[2,1],[1,2]]],[[[2,1],[0,1]]],[[[1,0],[2,1]]],[[[1,2],[0,1]],[[1,0],[2,1]]],[[[1,0],[1,2]]],[[[1,0],[0,1]]],[[[0,1],[1,0]]],[[[1,2],[1,0]]],[[[0,1],[1,0]],[[2,1],[1,2]]],[[[2,1],[1,0]]],[[[0,1],[2,1]]],[[[1,2],[2,1]]],[[[0,1],[1,2]]],[]];function i(e,t,r,i){return(t=2*t+i[0])+(r=2*r+i[1])*(e+1)*2}function n(e,t,r){return(t-e)/(r-e)}function s(e,s,o=4096,a=1){if(!e)return{};const l=o/(s.width-1);let h,c,d,u,f,p;const g={},w=new Map,m=new Map;function y(e,t,r){0===e[0]?r(l*(p-1),l*(f-n(d,t,h))):2===e[0]?r(l*p,l*(f-n(u,t,c))):0===e[1]?r(l*(p-n(c,t,h)),l*(f-1)):r(l*(p-n(u,t,d)),l*f)}for(f=1-a;f<s.height+a;f++){c=s.get(0,f-1),u=s.get(0,f);let n=Math.min(c,u),o=Math.max(c,u);for(p=1-a;p<s.width+a;p++){h=c,d=u,c=s.get(p,f-1),u=s.get(p,f);const a=n,l=o;if(n=Math.min(c,u),o=Math.max(c,u),isNaN(h)||isNaN(c)||isNaN(u)||isNaN(d))continue;const v=Math.min(a,n),b=Math.max(l,o),x=Math.ceil(v/e)*e,T=Math.floor(b/e)*e;for(let n=x;n<=T;n+=e){const e=h>n,o=c>n,a=d>n,l=u>n;for(const h of r[(e?8:0)|(o?4:0)|(l?2:0)|(a?1:0)]){let e=w.get(n);e||w.set(n,e=new Map);let r=m.get(n);r||m.set(n,r=new Map);const o=h[0],a=h[1],l=i(s.width,p,f,o),c=i(s.width,p,f,a);let d,u;if(d=r.get(l))if(r.delete(l),u=e.get(c))if(e.delete(c),d===u){if(y(a,n,d.append),!d.isEmpty()){let e=g[n];e||(g[n]=e=[]),e.push(d.lineString())}}else d.appendFragment(u),r.set(d.end=u.end,d);else y(a,n,d.append),r.set(d.end=c,d);else if(d=e.get(c))e.delete(c),y(o,n,d.prepend),e.set(d.start=l,d);else{const i=new t(l,c);y(o,n,i.append),y(a,n,i.append),e.set(l,i),r.set(c,i)}}}}}for(const[e,t]of w.entries()){let r=null;for(const i of t.values())i.isEmpty()||(null==r&&(r=g[e]||(g[e]=[])),r.push(i.lineString()))}return g}
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function o(e,t){var r={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(r[i[n]]=e[i[n]])}return r}function a(e,t,r,i){return new(r||(r=Promise))((function(n,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function a(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}l((i=i.apply(e,t||[])).next())}))}function l(e){const t=Object.entries(e);return t.sort((([e],[t])=>e<t?-1:e>t?1:0)),t}function h(e){return l(e).map((([e,t])=>[e,..."number"==typeof t?[t]:t].join("*"))).join("~")}function c(e){return l(e).map((([e,t])=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join(",")}let d=null;function u(){return null==d&&(d="undefined"!=typeof OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof createImageBitmap),d||!1}let f=null;function p(e,t){t&&(null==e||e.signal.addEventListener("abort",t))}function g(e){var t;return Boolean(null===(t=null==e?void 0:e.signal)||void 0===t?void 0:t.aborted)}let w=0;class m{constructor(e=100){this.size=()=>this.items.size,this.get=(e,t,r)=>{let i=this.items.get(e);if(i)i.lastUsed=++w,i.waiting++;else{const r=new AbortController,n=t(e,r);i={abortController:r,item:n,lastUsed:++w,waiting:1},this.items.set(e,i),this.prune()}const n=this.items,s=i.item.then((e=>e),(t=>(n.delete(e),Promise.reject(t))));let o=!1;return p(r,(()=>{var t;i&&i.abortController&&!o&&(o=!0,--i.waiting<=0&&(null===(t=i.abortController)||void 0===t||t.abort(),n.delete(e)))})),s},this.clear=()=>this.items.clear(),this.maxSize=e,this.items=new Map}prune(){if(this.items.size>this.maxSize){let e,t=1/0;this.items.forEach(((r,i)=>{r.lastUsed<t&&(t=r.lastUsed,e=i)})),void 0!==e&&this.items.delete(e)}}}var y=Uint8Array,v=Uint16Array,b=Int32Array,x=new y([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),T=new y([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),P=new y([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),M=function(e,t){for(var r=new v(31),i=0;i<31;++i)r[i]=t+=1<<e[i-1];var n=new b(r[30]);for(i=1;i<30;++i)for(var s=r[i];s<r[i+1];++s)n[s]=s-r[i]<<5|i;return{b:r,r:n}},k=M(x,2),E=k.b,C=k.r;E[28]=258,C[258]=28;for(var U=M(T,0).b,F=new v(32768),V=0;V<32768;++V){var O=(43690&V)>>1|(21845&V)<<1;O=(61680&(O=(52428&O)>>2|(13107&O)<<2))>>4|(3855&O)<<4,F[V]=((65280&O)>>8|(255&O)<<8)>>1}var S=function(e,t,r){for(var i=e.length,n=0,s=new v(t);n<i;++n)e[n]&&++s[e[n]-1];var o,a=new v(t);for(n=1;n<t;++n)a[n]=a[n-1]+s[n-1]<<1;if(r){o=new v(1<<t);var l=15-t;for(n=0;n<i;++n)if(e[n])for(var h=n<<4|e[n],c=t-e[n],d=a[e[n]-1]++<<c,u=d|(1<<c)-1;d<=u;++d)o[F[d]>>l]=h}else for(o=new v(i),n=0;n<i;++n)e[n]&&(o[n]=F[a[e[n]-1]++]>>15-e[n]);return o},N=new y(288);for(V=0;V<144;++V)N[V]=8;for(V=144;V<256;++V)N[V]=9;for(V=256;V<280;++V)N[V]=7;for(V=280;V<288;++V)N[V]=8;var I=new y(32);for(V=0;V<32;++V)I[V]=5;var D=S(N,9,1),A=S(I,5,1),B=function(e){for(var t=e[0],r=1;r<e.length;++r)e[r]>t&&(t=e[r]);return t},z=function(e,t,r){var i=t/8|0;return(e[i]|e[i+1]<<8)>>(7&t)&r},$=function(e,t){var r=t/8|0;return(e[r]|e[r+1]<<8|e[r+2]<<16)>>(7&t)},R=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],j=function(e,t,r){var i=new Error(t||R[e]);if(i.code=e,Error.captureStackTrace&&Error.captureStackTrace(i,j),!r)throw i;return i},H=function(e,t,r,i){var n=e.length;if(!n||t.f&&!t.l)return r||new y(0);var s=!r,o=s||2!=t.i,a=t.i;s&&(r=new y(3*n));var l=function(e){var t=r.length;if(e>t){var i=new y(Math.max(2*t,e));i.set(r),r=i}},h=t.f||0,c=t.p||0,d=t.b||0,u=t.l,f=t.d,p=t.m,g=t.n,w=8*n;do{if(!u){h=z(e,c,1);var m=z(e,c+1,3);if(c+=3,!m){var v=e[(R=4+((c+7)/8|0))-4]|e[R-3]<<8,b=R+v;if(b>n){a&&j(0);break}o&&l(d+v),r.set(e.subarray(R,b),d),t.b=d+=v,t.p=c=8*b,t.f=h;continue}if(1==m)u=D,f=A,p=9,g=5;else if(2==m){var M=z(e,c,31)+257,k=z(e,c+10,15)+4,C=M+z(e,c+5,31)+1;c+=14;for(var F=new y(C),V=new y(19),O=0;O<k;++O)V[P[O]]=z(e,c+3*O,7);c+=3*k;var N=B(V),I=(1<<N)-1,L=S(V,N,1);for(O=0;O<C;){var R,H=L[z(e,c,I)];if(c+=15&H,(R=H>>4)<16)F[O++]=R;else{var Z=0,G=0;for(16==R?(G=3+z(e,c,3),c+=2,Z=F[O-1]):17==R?(G=3+z(e,c,7),c+=3):18==R&&(G=11+z(e,c,127),c+=7);G--;)F[O++]=Z}}var W=F.subarray(0,M),K=F.subarray(M);p=B(W),g=B(K),u=S(W,p,1),f=S(K,g,1)}else j(1);if(c>w){a&&j(0);break}}o&&l(d+131072);for(var _=(1<<p)-1,J=(1<<g)-1,q=c;;q=c){var Y=(Z=u[$(e,c)&_])>>4;if((c+=15&Z)>w){a&&j(0);break}if(Z||j(2),Y<256)r[d++]=Y;else{if(256==Y){q=c,u=null;break}var Q=Y-254;if(Y>264){var X=x[O=Y-257];Q=z(e,c,(1<<X)-1)+E[O],c+=X}var ee=f[$(e,c)&J],te=ee>>4;ee||j(3),c+=15&ee;K=U[te];if(te>3){X=T[te];K+=$(e,c)&(1<<X)-1,c+=X}if(c>w){a&&j(0);break}o&&l(d+131072);var re=d+Q;if(d<K){var ie=0-K,ne=Math.min(K,re);for(ie+d<0&&j(3);d<ne;++d)r[d]=i[ie+d]}for(;d<re;++d)r[d]=r[d-K]}}t.l=u,t.p=q,t.b=d,t.f=h,u&&(h=1,t.m=p,t.d=f,t.n=g)}while(!h);return d!=r.length&&s?function(e,t,r){return(null==r||r>e.length)&&(r=e.length),new y(e.subarray(t,r))}(r,0,d):r.subarray(0,d)},Z=new y(0),G=function(e){31==e[0]&&139==e[1]&&8==e[2]||j(6,"invalid gzip data");var t=e[3],r=10;4&t&&(r+=2+(e[10]|e[11]<<8));for(var i=(t>>3&1)+(t>>4&1);i>0;i-=!e[r++]);return r+(2&t)},W=function(e){var t=e.length;return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0},K=function(e,t){return(8!=(15&e[0])||e[0]>>4>7||(e[0]<<8|e[1])%31)&&j(6,"invalid zlib data"),(e[1]>>5&1)==+!t&&j(6,"invalid zlib data: "+(32&e[1]?"need":"unexpected")+" dictionary"),2+(e[1]>>3&4)};function _(e,t){return 31==e[0]&&139==e[1]&&8==e[2]?function(e,t){var r=G(e);return r+8>e.length&&j(6,"invalid gzip data"),H(e.subarray(r,-8),{i:2},new y(W(e)),t)}(e,t):8!=(15&e[0])||e[0]>>4>7||(e[0]<<8|e[1])%31?function(e,t){return H(e,{i:2},t,t)}(e,t):function(e,t){return H(e.subarray(K(e,t),-4),{i:2},t,t)}(e,t)}var J="undefined"!=typeof TextDecoder&&new TextDecoder;try{J.decode(Z,{stream:!0}),1}catch(e){}var q=Object.defineProperty,Y=Math.pow,Q=(e,t)=>q(e,"name",{value:t,configurable:!0}),X=(e,t,r)=>new Promise(((i,n)=>{var s=e=>{try{a(r.next(e))}catch(e){n(e)}},o=e=>{try{a(r.throw(e))}catch(e){n(e)}},a=e=>e.done?i(e.value):Promise.resolve(e.value).then(s,o);a((r=r.apply(e,t)).next())}));Q(((e,t)=>{let r=!1,i="";return new(L.GridLayer.extend({createTile:Q(((t,n)=>{let s=document.createElement("img"),o=new AbortController,a=o.signal;return s.cancel=()=>{o.abort()},r||(e.getHeader().then((e=>{1===e.tileType?console.error("Error: archive contains MVT vector tiles, but leafletRasterLayer is for displaying raster tiles. See https://github.com/protomaps/PMTiles/tree/main/js for details."):2===e.tileType?i="image/png":3===e.tileType?i="image/jpeg":4===e.tileType?i="image/webp":5===e.tileType&&(i="image/avif")})),r=!0),e.getZxy(t.z,t.x,t.y,a).then((e=>{if(e){let t=new Blob([e.data],{type:i}),r=window.URL.createObjectURL(t);s.src=r,s.cancel=void 0,n(void 0,s)}})).catch((e=>{if("AbortError"!==e.name)throw e})),s}),"createTile"),_removeTile:Q((function(e){let t=this._tiles[e];t&&(t.el.cancel&&t.el.cancel(),t.el.width=0,t.el.height=0,t.el.deleted=!0,L.DomUtil.remove(t.el),delete this._tiles[e],this.fire("tileunload",{tile:t.el,coords:this._keyToTileCoords(e)}))}),"_removeTile")}))(t)}),"leafletRasterLayer");var ee=Q((e=>(t,r)=>{if(r instanceof AbortController)return e(t,r);let i=new AbortController;return e(t,i).then((e=>r(void 0,e.data,e.cacheControl||"",e.expires||"")),(e=>r(e))).catch((e=>r(e))),{cancel:Q((()=>i.abort()),"cancel")}}),"v3compat");function te(e,t){return 4294967296*(t>>>0)+(e>>>0)}function re(e,t){let r=t.buf,i=r[t.pos++],n=(112&i)>>4;if(i<128||(i=r[t.pos++],n|=(127&i)<<3,i<128)||(i=r[t.pos++],n|=(127&i)<<10,i<128)||(i=r[t.pos++],n|=(127&i)<<17,i<128)||(i=r[t.pos++],n|=(127&i)<<24,i<128)||(i=r[t.pos++],n|=(1&i)<<31,i<128))return te(e,n);throw new Error("Expected varint not more than 10 bytes")}function ie(e){let t=e.buf,r=t[e.pos++],i=127&r;return r<128||(r=t[e.pos++],i|=(127&r)<<7,r<128)||(r=t[e.pos++],i|=(127&r)<<14,r<128)||(r=t[e.pos++],i|=(127&r)<<21,r<128)?i:(r=t[e.pos],i|=(15&r)<<28,re(i,e))}function ne(e,t,r,i){if(0===i){1===r&&(t[0]=e-1-t[0],t[1]=e-1-t[1]);let i=t[0];t[0]=t[1],t[1]=i}}function se(e,t){let r=Y(2,e),i=t,n=t,s=t,o=[0,0],a=1;for(;a<r;)i=1&s/2,n=1&(s^i),ne(a,o,i,n),o[0]+=a*i,o[1]+=a*n,s/=4,a*=2;return[e,o[0],o[1]]}Q(class{constructor(e){this.tilev4=Q(((e,t)=>X(this,null,(function*(){if("json"===e.type){let t=e.url.substr(10),r=this.tiles.get(t);if(r||(r=new Ce(t),this.tiles.set(t,r)),this.metadata)return{data:yield r.getTileJson(e.url)};let i=yield r.getHeader();return{data:{tiles:[`${e.url}/{z}/{x}/{y}`],minzoom:i.minZoom,maxzoom:i.maxZoom,bounds:[i.minLon,i.minLat,i.maxLon,i.maxLat]}}}let r=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),i=e.url.match(r);if(!i)throw new Error("Invalid PMTiles protocol URL");let n=i[1],s=this.tiles.get(n);s||(s=new Ce(n),this.tiles.set(n,s));let o=i[2],a=i[3],l=i[4],h=yield s.getHeader(),c=yield null==s?void 0:s.getZxy(+o,+a,+l,t.signal);if(c)return{data:new Uint8Array(c.data),cacheControl:c.cacheControl,expires:c.expires};if(1===h.tileType){if(this.errorOnMissingTile)throw new Error("Tile not found.");return{data:new Uint8Array}}return{data:null}}))),"tilev4"),this.tile=ee(this.tilev4),this.tiles=new Map,this.metadata=(null==e?void 0:e.metadata)||!1,this.errorOnMissingTile=(null==e?void 0:e.errorOnMissingTile)||!1}add(e){this.tiles.set(e.source.getKey(),e)}get(e){return this.tiles.get(e)}},"Protocol"),Q(te,"toNum"),Q(re,"readVarintRemainder"),Q(ie,"readVarint"),Q(ne,"rotate"),Q(se,"idOnLevel");var oe=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function ae(e,t,r){if(e>26)throw new Error("Tile zoom level exceeds max safe number limit (26)");if(t>Y(2,e)-1||r>Y(2,e)-1)throw new Error("tile x/y outside zoom level bounds");let i=oe[e],n=0,s=0,o=0,a=[t,r],l=Y(2,e)/2;for(;l>0;)n=(a[0]&l)>0?1:0,s=(a[1]&l)>0?1:0,o+=l*l*(3*n^s),ne(l,a,n,s),l/=2;return i+o}Q(ae,"zxyToTileId"),Q((function(e){let t=0;for(let r=0;r<27;r++){let i=(1<<r)*(1<<r);if(t+i>e)return se(r,e-t);t+=i}throw new Error("Tile zoom level exceeds max safe number limit (26)")}),"tileIdToZxy");var le,he=((le=he||{})[le.Unknown=0]="Unknown",le[le.None=1]="None",le[le.Gzip=2]="Gzip",le[le.Brotli=3]="Brotli",le[le.Zstd=4]="Zstd",le);function ce(e,t){return X(this,null,(function*(){if(1===t||0===t)return e;if(2===t){if(void 0===globalThis.DecompressionStream)return _(new Uint8Array(e));let t=new Response(e).body;if(!t)throw new Error("Failed to read response stream");let r=t.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(r).arrayBuffer()}throw new Error("Compression method not supported")}))}Q(ce,"defaultDecompress");var de,ue=((de=ue||{})[de.Unknown=0]="Unknown",de[de.Mvt=1]="Mvt",de[de.Png=2]="Png",de[de.Jpeg=3]="Jpeg",de[de.Webp=4]="Webp",de[de.Avif=5]="Avif",de);function fe(e){return 1===e?".mvt":2===e?".png":3===e?".jpg":4===e?".webp":5===e?".avif":""}Q(fe,"tileTypeExt");function pe(e,t){let r=0,i=e.length-1;for(;r<=i;){let n=i+r>>1,s=t-e[n].tileId;if(s>0)r=n+1;else{if(!(s<0))return e[n];i=n-1}}return i>=0&&(0===e[i].runLength||t-e[i].tileId<e[i].runLength)?e[i]:null}Q(pe,"findTile");Q(class{constructor(e){this.file=e}getKey(){return this.file.name}getBytes(e,t){return X(this,null,(function*(){return{data:yield this.file.slice(e,e+t).arrayBuffer()}}))}},"FileSource");var ge=class{constructor(e,t=new Headers){this.url=e,this.customHeaders=t,this.mustReload=!1;let r="";"navigator"in globalThis&&(r=globalThis.navigator.userAgent||"");let i=r.indexOf("Windows")>-1,n=/Chrome|Chromium|Edg|OPR|Brave/.test(r);this.chromeWindowsNoCache=!1,i&&n&&(this.chromeWindowsNoCache=!0)}getKey(){return this.url}setHeaders(e){this.customHeaders=e}getBytes(e,t,r,i){return X(this,null,(function*(){let n,s;r?s=r:(n=new AbortController,s=n.signal);let o,a=new Headers(this.customHeaders);a.set("range",`bytes=${e}-${e+t-1}`),this.mustReload?o="reload":this.chromeWindowsNoCache&&(o="no-store");let l=yield fetch(this.url,{signal:s,cache:o,headers:a});if(0===e&&416===l.status){let e=l.headers.get("Content-Range");if(!e||!e.startsWith("bytes */"))throw new Error("Missing content-length on 416 response");let t=+e.substr(8);l=yield fetch(this.url,{signal:s,cache:"reload",headers:{range:"bytes=0-"+(t-1)}})}let h=l.headers.get("Etag");if(null!=h&&h.startsWith("W/")&&(h=null),416===l.status||i&&h&&h!==i)throw this.mustReload=!0,new xe(`Server returned non-matching ETag ${i} after one retry. Check browser extensions and servers for issues that may affect correct ETag headers.`);if(l.status>=300)throw new Error(`Bad response code: ${l.status}`);let c=l.headers.get("Content-Length");if(200===l.status&&(!c||+c>t))throw n&&n.abort(),new Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield l.arrayBuffer(),etag:h||void 0,cacheControl:l.headers.get("Cache-Control")||void 0,expires:l.headers.get("Expires")||void 0}}))}};Q(ge,"FetchSource");var we=ge;function me(e,t){let r=e.getUint32(t+4,!0),i=e.getUint32(t+0,!0);return r*Y(2,32)+i}function ye(e,t){let r=new DataView(e),i=r.getUint8(7);if(i>3)throw new Error(`Archive is spec version ${i} but this library supports up to spec version 3`);return{specVersion:i,rootDirectoryOffset:me(r,8),rootDirectoryLength:me(r,16),jsonMetadataOffset:me(r,24),jsonMetadataLength:me(r,32),leafDirectoryOffset:me(r,40),leafDirectoryLength:me(r,48),tileDataOffset:me(r,56),tileDataLength:me(r,64),numAddressedTiles:me(r,72),numTileEntries:me(r,80),numTileContents:me(r,88),clustered:1===r.getUint8(96),internalCompression:r.getUint8(97),tileCompression:r.getUint8(98),tileType:r.getUint8(99),minZoom:r.getUint8(100),maxZoom:r.getUint8(101),minLon:r.getInt32(102,!0)/1e7,minLat:r.getInt32(106,!0)/1e7,maxLon:r.getInt32(110,!0)/1e7,maxLat:r.getInt32(114,!0)/1e7,centerZoom:r.getUint8(118),centerLon:r.getInt32(119,!0)/1e7,centerLat:r.getInt32(123,!0)/1e7,etag:t}}function ve(e){let t={buf:new Uint8Array(e),pos:0},r=ie(t),i=[],n=0;for(let e=0;e<r;e++){let e=ie(t);i.push({tileId:n+e,offset:0,length:0,runLength:1}),n+=e}for(let e=0;e<r;e++)i[e].runLength=ie(t);for(let e=0;e<r;e++)i[e].length=ie(t);for(let e=0;e<r;e++){let r=ie(t);i[e].offset=0===r&&e>0?i[e-1].offset+i[e-1].length:r-1}return i}Q(me,"getUint64"),Q(ye,"bytesToHeader"),Q(ve,"deserializeIndex");var be=class extends Error{};Q(be,"EtagMismatch");var xe=be;function Te(e,t){return X(this,null,(function*(){let r=yield e.getBytes(0,16384);if(19792!==new DataView(r.data).getUint16(0,!0))throw new Error("Wrong magic number for PMTiles archive");let i=ye(r.data.slice(0,127),r.etag),n=r.data.slice(i.rootDirectoryOffset,i.rootDirectoryOffset+i.rootDirectoryLength),s=`${e.getKey()}|${i.etag||""}|${i.rootDirectoryOffset}|${i.rootDirectoryLength}`,o=ve(yield t(n,i.internalCompression));return[i,[s,o.length,o]]}))}function Pe(e,t,r,i,n){return X(this,null,(function*(){let s=yield e.getBytes(r,i,void 0,n.etag),o=ve(yield t(s.data,n.internalCompression));if(0===o.length)throw new Error("Empty directory is invalid");return o}))}Q(Te,"getHeaderAndRoot"),Q(Pe,"getDirectory");Q(class{constructor(e=100,t=!0,r=ce){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=r}getHeader(e){return X(this,null,(function*(){let t=e.getKey(),r=this.cache.get(t);if(r)return r.lastUsed=this.counter++,r.data;let i=yield Te(e,this.decompress);return i[1]&&this.cache.set(i[1][0],{lastUsed:this.counter++,data:i[1][2]}),this.cache.set(t,{lastUsed:this.counter++,data:i[0]}),this.prune(),i[0]}))}getDirectory(e,t,r,i){return X(this,null,(function*(){let n=`${e.getKey()}|${i.etag||""}|${t}|${r}`,s=this.cache.get(n);if(s)return s.lastUsed=this.counter++,s.data;let o=yield Pe(e,this.decompress,t,r,i);return this.cache.set(n,{lastUsed:this.counter++,data:o}),this.prune(),o}))}prune(){if(this.cache.size>this.maxCacheEntries){let e,t=1/0;this.cache.forEach(((r,i)=>{r.lastUsed<t&&(t=r.lastUsed,e=i)})),e&&this.cache.delete(e)}}invalidate(e){return X(this,null,(function*(){this.cache.delete(e.getKey())}))}},"ResolvedValueCache");var Me=class{constructor(e=100,t=!0,r=ce){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=r}getHeader(e){return X(this,null,(function*(){let t=e.getKey(),r=this.cache.get(t);if(r)return r.lastUsed=this.counter++,yield r.data;let i=new Promise(((t,r)=>{Te(e,this.decompress).then((e=>{e[1]&&this.cache.set(e[1][0],{lastUsed:this.counter++,data:Promise.resolve(e[1][2])}),t(e[0]),this.prune()})).catch((e=>{r(e)}))}));return this.cache.set(t,{lastUsed:this.counter++,data:i}),i}))}getDirectory(e,t,r,i){return X(this,null,(function*(){let n=`${e.getKey()}|${i.etag||""}|${t}|${r}`,s=this.cache.get(n);if(s)return s.lastUsed=this.counter++,yield s.data;let o=new Promise(((n,s)=>{Pe(e,this.decompress,t,r,i).then((e=>{n(e),this.prune()})).catch((e=>{s(e)}))}));return this.cache.set(n,{lastUsed:this.counter++,data:o}),o}))}prune(){if(this.cache.size>=this.maxCacheEntries){let e,t=1/0;this.cache.forEach(((r,i)=>{r.lastUsed<t&&(t=r.lastUsed,e=i)})),e&&this.cache.delete(e)}}invalidate(e){return X(this,null,(function*(){let t=e.getKey();if(this.invalidations.get(t))return yield this.invalidations.get(t);this.cache.delete(e.getKey());let r=new Promise(((r,i)=>{this.getHeader(e).then((e=>{r(),this.invalidations.delete(t)})).catch((e=>{i(e)}))}));this.invalidations.set(t,r)}))}};Q(Me,"SharedPromiseCache");var ke=Me,Ee=class{constructor(e,t,r){this.source="string"==typeof e?new we(e):e,this.decompress=r||ce,this.cache=t||new ke}getHeader(){return X(this,null,(function*(){return yield this.cache.getHeader(this.source)}))}getZxyAttempt(e,t,r,i){return X(this,null,(function*(){let n=ae(e,t,r),s=yield this.cache.getHeader(this.source);if(e<s.minZoom||e>s.maxZoom)return;let o=s.rootDirectoryOffset,a=s.rootDirectoryLength;for(let e=0;e<=3;e++){let e=pe(yield this.cache.getDirectory(this.source,o,a,s),n);if(!e)return;if(e.runLength>0){let t=yield this.source.getBytes(s.tileDataOffset+e.offset,e.length,i,s.etag);return{data:yield this.decompress(t.data,s.tileCompression),cacheControl:t.cacheControl,expires:t.expires}}o=s.leafDirectoryOffset+e.offset,a=e.length}throw new Error("Maximum directory depth exceeded")}))}getZxy(e,t,r,i){return X(this,null,(function*(){try{return yield this.getZxyAttempt(e,t,r,i)}catch(n){if(n instanceof xe)return this.cache.invalidate(this.source),yield this.getZxyAttempt(e,t,r,i);throw n}}))}getMetadataAttempt(){return X(this,null,(function*(){let e=yield this.cache.getHeader(this.source),t=yield this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength,void 0,e.etag),r=yield this.decompress(t.data,e.internalCompression),i=new TextDecoder("utf-8");return JSON.parse(i.decode(r))}))}getMetadata(){return X(this,null,(function*(){try{return yield this.getMetadataAttempt()}catch(e){if(e instanceof xe)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw e}}))}getTileJson(e){return X(this,null,(function*(){let t=yield this.getHeader(),r=yield this.getMetadata(),i=fe(t.tileType);return{tilejson:"3.0.0",scheme:"xyz",tiles:[`${e}/{z}/{x}/{y}${i}`],vector_layers:r.vector_layers,attribution:r.attribution,description:r.description,name:r.name,version:r.version,bounds:[t.minLon,t.minLat,t.maxLon,t.maxLat],center:[t.centerLon,t.centerLat,t.centerZoom],minzoom:t.minZoom,maxzoom:t.maxZoom}}))}};Q(Ee,"PMTiles");var Ce=Ee;let Ue,Fe,Ve,Oe;function Se(e,t){return Ue||(Ue=new OffscreenCanvas(e.width,e.height),Fe=Ue.getContext("2d",{willReadFrequently:!0})),Ie(e,t,Ue,Fe)}const Ne=function(){if(null==f&&(f=!1,u()&&"undefined"!=typeof VideoFrame)){const e=5,t=new OffscreenCanvas(5,5).getContext("2d",{willReadFrequently:!0});if(t){for(let r=0;r<e*e;r++){const i=4*r;t.fillStyle=`rgb(${i},${i+1},${i+2})`,t.fillRect(r%e,Math.floor(r/e),1,1)}const r=t.getImageData(0,0,e,e).data;for(let t=0;t<e*e*4;t++)if(t%4!=3&&r[t]!==t){f=!0;break}}}return f||!1}()?function(e,t,r){return a(this,void 0,void 0,(function*(){var i,n,s;const o=yield createImageBitmap(e);if(g(r))return null;const a=new VideoFrame(o,{timestamp:0});try{if(!((null===(i=null==a?void 0:a.format)||void 0===i?void 0:i.startsWith("BGR"))||(null===(n=null==a?void 0:a.format)||void 0===n?void 0:n.startsWith("RGB"))))throw new Error(`Unrecognized format: ${null==a?void 0:a.format}`);const e=null===(s=null==a?void 0:a.format)||void 0===s?void 0:s.startsWith("BGR"),r=a.allocationSize(),l=new Uint8ClampedArray(r);if(yield a.copyTo(l),e)for(let e=0;e<l.length;e+=4){const t=l[e];l[e]=l[e+2],l[e+2]=t}return De(o.width,o.height,t,l)}catch(e){return g(r)?null:Se(o,t)}finally{a.close()}}))}:u()?function(e,t,r){return a(this,void 0,void 0,(function*(){const i=yield createImageBitmap(e);return g(r)?null:Se(i,t)}))}:"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope?function(e,t,r){return self.actor.send("decodeImage",[],r,void 0,e,t)}:"undefined"!=typeof document?function(e,t,r){return a(this,void 0,void 0,(function*(){Ve||(Ve=document.createElement("canvas"),Oe=Ve.getContext("2d",{willReadFrequently:!0}));const i=new Image;p(r,(()=>i.src=""));return Ie(yield new Promise(((t,n)=>{i.onload=()=>{g(r)||t(i),URL.revokeObjectURL(i.src),i.onload=null},i.onerror=()=>n(new Error("Could not load image.")),i.src=e.size?URL.createObjectURL(e):""})),t,Ve,Oe)}))}:function(e,t,r){return a(this,void 0,void 0,(function*(){const e=yield function(e,t){return a(this,void 0,void 0,(function*(){}))}();return g(r)?null:e}))};function Ie(e,t,r,i){if(r.width=e.width,r.height=e.height,!i)throw new Error("failed to get context");i.drawImage(e,0,0,e.width,e.height);const n=i.getImageData(0,0,e.width,e.height).data;return De(e.width,e.height,t,n)}function De(e,t,r,i){const n="mapbox"===r?(e,t,r)=>.1*(256*e*256+256*t+r)-1e4:(e,t,r)=>256*e+t+r/256-32768,s=new Float32Array(e*t);for(let e=0;e<i.length;e+=4)s[e/4]=n(i[e],i[e+1],i[e+2]);return{width:e,height:t,data:s}}class Le{constructor(e,t,r){this.split=(e,t,r)=>{if(0===e)return this;const i=1<<e,n=t*this.width/i,s=r*this.height/i;return new Le(this.width/i,this.height/i,((e,t)=>this.get(e+n,t+s)))},this.subsamplePixelCenters=e=>{const t=(e,t,r)=>isNaN(e)?t:isNaN(t)?e:e+(t-e)*r;if(e<=1)return this;const r=.5-1/(2*e);return new Le(this.width*e,this.height*e,((i,n)=>{const s=i/e-r,o=n/e-r,a=Math.floor(s),l=Math.floor(o),h=this.get(a,l),c=this.get(a+1,l),d=this.get(a,l+1),u=this.get(a+1,l+1),f=s-a,p=o-l,g=t(h,c,f),w=t(d,u,f);return t(g,w,p)}))},this.averagePixelCentersToGrid=(e=1)=>new Le(this.width+1,this.height+1,((t,r)=>{let i=0,n=0,s=0;for(let o=t-e;o<t+e;o++)for(let t=r-e;t<r+e;t++)isNaN(s=this.get(o,t))||(n++,i+=s);return 0===n?NaN:i/n})),this.scaleElevation=e=>1===e?this:new Le(this.width,this.height,((t,r)=>this.get(t,r)*e)),this.materialize=(e=2)=>{const t=this.width+2*e,r=new Float32Array(t*(this.height+2*e));let i=0;for(let t=-e;t<this.height+e;t++)for(let n=-e;n<this.width+e;n++)r[i++]=this.get(n,t);return new Le(this.width,this.height,((i,n)=>r[(n+e)*t+i+e]))},this.get=r,this.width=e,this.height=t}static fromRawDem(e){return new Le(e.width,e.height,((t,r)=>{const i=e.data[r*e.width+t];return n=i,!isNaN(n)&&n>=-12e3&&n<=9e3?i:NaN;var n}))}static combineNeighbors(e){if(9!==e.length)throw new Error("Must include a tile plus 8 neighbors");const t=e[4];if(!t)return;const r=t.width,i=t.height;return new Le(r,i,((t,n)=>{let s=0;n<0?n+=i:n<i?s+=3:(n-=i,s+=6),t<0?t+=r:t<r?s+=1:(t-=r,s+=2);const o=e[s];return o?o.get(t,n):NaN}))}}const Ae=4294967296,Be=1/Ae,ze="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8");class $e{constructor(e=new Uint8Array(16)){this.buf=ArrayBuffer.isView(e)?e:new Uint8Array(e),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(e,t,r=this.length){for(;this.pos<r;){const r=this.readVarint(),i=r>>3,n=this.pos;this.type=7&r,e(i,t,this),this.pos===n&&this.skip(r)}return t}readMessage(e,t){return this.readFields(e,t,this.readVarint()+this.pos)}readFixed32(){const e=this.dataView.getUint32(this.pos,!0);return this.pos+=4,e}readSFixed32(){const e=this.dataView.getInt32(this.pos,!0);return this.pos+=4,e}readFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*Ae;return this.pos+=8,e}readSFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*Ae;return this.pos+=8,e}readFloat(){const e=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,e}readDouble(){const e=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,e}readVarint(e){const t=this.buf;let r,i;return i=t[this.pos++],r=127&i,i<128?r:(i=t[this.pos++],r|=(127&i)<<7,i<128?r:(i=t[this.pos++],r|=(127&i)<<14,i<128?r:(i=t[this.pos++],r|=(127&i)<<21,i<128?r:(i=t[this.pos],r|=(15&i)<<28,function(e,t,r){const i=r.buf;let n,s;if(s=i[r.pos++],n=(112&s)>>4,s<128)return Re(e,n,t);if(s=i[r.pos++],n|=(127&s)<<3,s<128)return Re(e,n,t);if(s=i[r.pos++],n|=(127&s)<<10,s<128)return Re(e,n,t);if(s=i[r.pos++],n|=(127&s)<<17,s<128)return Re(e,n,t);if(s=i[r.pos++],n|=(127&s)<<24,s<128)return Re(e,n,t);if(s=i[r.pos++],n|=(1&s)<<31,s<128)return Re(e,n,t);throw new Error("Expected varint not more than 10 bytes")}(r,e,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const e=this.readVarint();return e%2==1?(e+1)/-2:e/2}readBoolean(){return Boolean(this.readVarint())}readString(){const e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=12&&ze?ze.decode(this.buf.subarray(t,e)):function(e,t,r){let i="",n=t;for(;n<r;){const t=e[n];let s,o,a,l=null,h=t>239?4:t>223?3:t>191?2:1;if(n+h>r)break;1===h?t<128&&(l=t):2===h?(s=e[n+1],128==(192&s)&&(l=(31&t)<<6|63&s,l<=127&&(l=null))):3===h?(s=e[n+1],o=e[n+2],128==(192&s)&&128==(192&o)&&(l=(15&t)<<12|(63&s)<<6|63&o,(l<=2047||l>=55296&&l<=57343)&&(l=null))):4===h&&(s=e[n+1],o=e[n+2],a=e[n+3],128==(192&s)&&128==(192&o)&&128==(192&a)&&(l=(15&t)<<18|(63&s)<<12|(63&o)<<6|63&a,(l<=65535||l>=1114112)&&(l=null))),null===l?(l=65533,h=1):l>65535&&(l-=65536,i+=String.fromCharCode(l>>>10&1023|55296),l=56320|1023&l),i+=String.fromCharCode(l),n+=h}return i}(this.buf,t,e)}readBytes(){const e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t}readPackedVarint(e=[],t){const r=this.readPackedEnd();for(;this.pos<r;)e.push(this.readVarint(t));return e}readPackedSVarint(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSVarint());return e}readPackedBoolean(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readBoolean());return e}readPackedFloat(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFloat());return e}readPackedDouble(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readDouble());return e}readPackedFixed32(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFixed32());return e}readPackedSFixed32(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSFixed32());return e}readPackedFixed64(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFixed64());return e}readPackedSFixed64(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSFixed64());return e}readPackedEnd(){return 2===this.type?this.readVarint()+this.pos:this.pos+1}skip(e){const t=7&e;if(0===t)for(;this.buf[this.pos++]>127;);else if(2===t)this.pos=this.readVarint()+this.pos;else if(5===t)this.pos+=4;else{if(1!==t)throw new Error(`Unimplemented type: ${t}`);this.pos+=8}}writeTag(e,t){this.writeVarint(e<<3|t)}realloc(e){let t=this.length||16;for(;t<this.pos+e;)t*=2;if(t!==this.length){const e=new Uint8Array(t);e.set(this.buf),this.buf=e,this.dataView=new DataView(e.buffer),this.length=t}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeSFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,-1&e,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*Be),!0),this.pos+=8}writeSFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,-1&e,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*Be),!0),this.pos+=8}writeVarint(e){(e=+e||0)>268435455||e<0?function(e,t){let r,i;e>=0?(r=e%4294967296|0,i=e/4294967296|0):(r=~(-e%4294967296),i=~(-e/4294967296),4294967295^r?r=r+1|0:(r=0,i=i+1|0));if(e>=0x10000000000000000||e<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");t.realloc(10),function(e,t,r){r.buf[r.pos++]=127&e|128,e>>>=7,r.buf[r.pos++]=127&e|128,e>>>=7,r.buf[r.pos++]=127&e|128,e>>>=7,r.buf[r.pos++]=127&e|128,e>>>=7,r.buf[r.pos]=127&e}(r,0,t),function(e,t){const r=(7&e)<<4;if(t.buf[t.pos++]|=r|((e>>>=3)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;t.buf[t.pos++]=127&e}(i,t)}(e,this):(this.realloc(4),this.buf[this.pos++]=127&e|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=e>>>7&127))))}writeSVarint(e){this.writeVarint(e<0?2*-e-1:2*e)}writeBoolean(e){this.writeVarint(+e)}writeString(e){e=String(e),this.realloc(4*e.length),this.pos++;const t=this.pos;this.pos=function(e,t,r){for(let i,n,s=0;s<t.length;s++){if(i=t.charCodeAt(s),i>55295&&i<57344){if(!n){i>56319||s+1===t.length?(e[r++]=239,e[r++]=191,e[r++]=189):n=i;continue}if(i<56320){e[r++]=239,e[r++]=191,e[r++]=189,n=i;continue}i=n-55296<<10|i-56320|65536,n=null}else n&&(e[r++]=239,e[r++]=191,e[r++]=189,n=null);i<128?e[r++]=i:(i<2048?e[r++]=i>>6|192:(i<65536?e[r++]=i>>12|224:(e[r++]=i>>18|240,e[r++]=i>>12&63|128),e[r++]=i>>6&63|128),e[r++]=63&i|128)}return r}(this.buf,e,this.pos);const r=this.pos-t;r>=128&&je(t,r,this),this.pos=t-1,this.writeVarint(r),this.pos+=r}writeFloat(e){this.realloc(4),this.dataView.setFloat32(this.pos,e,!0),this.pos+=4}writeDouble(e){this.realloc(8),this.dataView.setFloat64(this.pos,e,!0),this.pos+=8}writeBytes(e){const t=e.length;this.writeVarint(t),this.realloc(t);for(let r=0;r<t;r++)this.buf[this.pos++]=e[r]}writeRawMessage(e,t){this.pos++;const r=this.pos;e(t,this);const i=this.pos-r;i>=128&&je(r,i,this),this.pos=r-1,this.writeVarint(i),this.pos+=i}writeMessage(e,t,r){this.writeTag(e,2),this.writeRawMessage(t,r)}writePackedVarint(e,t){t.length&&this.writeMessage(e,He,t)}writePackedSVarint(e,t){t.length&&this.writeMessage(e,Ze,t)}writePackedBoolean(e,t){t.length&&this.writeMessage(e,Ke,t)}writePackedFloat(e,t){t.length&&this.writeMessage(e,Ge,t)}writePackedDouble(e,t){t.length&&this.writeMessage(e,We,t)}writePackedFixed32(e,t){t.length&&this.writeMessage(e,_e,t)}writePackedSFixed32(e,t){t.length&&this.writeMessage(e,Je,t)}writePackedFixed64(e,t){t.length&&this.writeMessage(e,qe,t)}writePackedSFixed64(e,t){t.length&&this.writeMessage(e,Ye,t)}writeBytesField(e,t){this.writeTag(e,2),this.writeBytes(t)}writeFixed32Field(e,t){this.writeTag(e,5),this.writeFixed32(t)}writeSFixed32Field(e,t){this.writeTag(e,5),this.writeSFixed32(t)}writeFixed64Field(e,t){this.writeTag(e,1),this.writeFixed64(t)}writeSFixed64Field(e,t){this.writeTag(e,1),this.writeSFixed64(t)}writeVarintField(e,t){this.writeTag(e,0),this.writeVarint(t)}writeSVarintField(e,t){this.writeTag(e,0),this.writeSVarint(t)}writeStringField(e,t){this.writeTag(e,2),this.writeString(t)}writeFloatField(e,t){this.writeTag(e,5),this.writeFloat(t)}writeDoubleField(e,t){this.writeTag(e,1),this.writeDouble(t)}writeBooleanField(e,t){this.writeVarintField(e,+t)}}function Re(e,t,r){return r?4294967296*t+(e>>>0):4294967296*(t>>>0)+(e>>>0)}function je(e,t,r){const i=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));r.realloc(i);for(let t=r.pos-1;t>=e;t--)r.buf[t+i]=r.buf[t]}function He(e,t){for(let r=0;r<e.length;r++)t.writeVarint(e[r])}function Ze(e,t){for(let r=0;r<e.length;r++)t.writeSVarint(e[r])}function Ge(e,t){for(let r=0;r<e.length;r++)t.writeFloat(e[r])}function We(e,t){for(let r=0;r<e.length;r++)t.writeDouble(e[r])}function Ke(e,t){for(let r=0;r<e.length;r++)t.writeBoolean(e[r])}function _e(e,t){for(let r=0;r<e.length;r++)t.writeFixed32(e[r])}function Je(e,t){for(let r=0;r<e.length;r++)t.writeSFixed32(e[r])}function qe(e,t){for(let r=0;r<e.length;r++)t.writeFixed64(e[r])}function Ye(e,t){for(let r=0;r<e.length;r++)t.writeSFixed64(e[r])}var Qe;function Xe(e,t){if(!t)throw new Error("pbf undefined");t.writeVarintField(15,2),t.writeStringField(1,e.id||""),t.writeVarintField(5,e.extent||4096);const r={keys:[],values:[],keycache:{},valuecache:{}};for(const i of e.features)r.feature=i,t.writeMessage(2,et,r);for(const e of r.keys)t.writeStringField(3,e);for(const e of r.values)t.writeMessage(4,st,e)}function et(e,t){const r=e.feature;if(!r||!t)throw new Error;t.writeMessage(2,tt,e),t.writeVarintField(3,r.type),t.writeMessage(4,nt,r)}function tt(e,t){const r=e.feature;if(!r||!t)throw new Error;const i=e.keys,n=e.values,s=e.keycache,o=e.valuecache;for(const e in r.properties){let a=r.properties[e],l=s[e];if(null===a)continue;void 0===l&&(i.push(e),l=i.length-1,s[e]=l),t.writeVarint(l);const h=typeof a;"string"!==h&&"boolean"!==h&&"number"!==h&&(a=JSON.stringify(a));const c=`${h}:${a}`;let d=o[c];void 0===d&&(n.push(a),d=n.length-1,o[c]=d),t.writeVarint(d)}}function rt(e,t){return(t<<3)+(7&e)}function it(e){return e<<1^e>>31}function nt(e,t){if(!t)throw new Error;const r=e.geometry,i=e.type;let n=0,s=0;for(const e of r){let r=1;i===Qe.POINT&&(r=e.length/2),t.writeVarint(rt(1,r));const o=e.length/2,a=i===Qe.POLYGON?o-1:o;for(let r=0;r<a;r++){1===r&&1!==i&&t.writeVarint(rt(2,a-1));const o=e[2*r]-n,l=e[2*r+1]-s;t.writeVarint(it(o)),t.writeVarint(it(l)),n+=o,s+=l}i===Qe.POLYGON&&t.writeVarint(rt(7,1))}}function st(e,t){if(!t)throw new Error;"string"==typeof e?t.writeStringField(1,e):"boolean"==typeof e?t.writeBooleanField(7,e):"number"==typeof e&&(e%1!=0?t.writeDoubleField(3,e):e<0?t.writeSVarintField(6,e):t.writeVarintField(5,e))}!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.POINT=1]="POINT",e[e.LINESTRING=2]="LINESTRING",e[e.POLYGON=3]="POLYGON"}(Qe||(Qe={}));const ot="undefined"!=typeof performance?performance:void 0,at=ot?ot.timeOrigin||(new Date).getTime()-ot.now():(new Date).getTime();function lt(e){var t;return JSON.parse(JSON.stringify((null===(t=null==ot?void 0:ot.getEntriesByName)||void 0===t?void 0:t.call(ot,e))||[]))}function ht(){return ot?ot.now():(new Date).getTime()}function ct(e){const t=[];for(const r of e)t.push(...r);return t}class dt{constructor(e){this.marks={},this.urls=[],this.fetched=[],this.resources=[],this.tilesFetched=0,this.timeOrigin=at,this.finish=e=>{this.markFinish();const t=e=>{const t=this.marks[e]||[],r=Math.max(...t.map((e=>Math.max(...e)))),i=Math.min(...t.map((e=>Math.min(...e))));return Number.isFinite(r)?r-i:void 0},r=t("main")||0,i=t("fetch"),n=t("decode"),s=t("isoline");return{url:e,tilesUsed:this.tilesFetched,origin:this.timeOrigin,marks:this.marks,resources:[...this.resources,...ct(this.fetched.map(lt))],duration:r,fetch:i,decode:n,process:s,wait:r-(i||0)-(n||0)-(s||0)}},this.error=e=>Object.assign(Object.assign({},this.finish(e)),{error:!0}),this.marker=e=>{var t;this.marks[e]||(this.marks[e]=[]);const r=[ht()];return null===(t=this.marks[e])||void 0===t||t.push(r),()=>r.push(ht())},this.useTile=e=>{this.urls.indexOf(e)<0&&(this.urls.push(e),this.tilesFetched++)},this.fetchTile=e=>{this.fetched.indexOf(e)<0&&this.fetched.push(e)},this.addAll=e=>{var t;this.tilesFetched+=e.tilesUsed;const r=e.origin-this.timeOrigin;for(const i in e.marks){const n=i;(this.marks[n]||(this.marks[n]=[])).push(...(null===(t=e.marks[n])||void 0===t?void 0:t.map((e=>e.map((e=>e+r)))))||[])}this.resources.push(...e.resources.map((e=>function(e,t){const r={};for(const i in e)0!==e[i]&&ut.test(i)?r[i]=Number(e[i])+t:r[i]=e[i];return r}(e,r))))},this.markFinish=this.marker(e)}}const ut=/(Start$|End$|^start|^end)/;let ft=0;e.A=class{constructor(e,t,r=2e4){this.callbacks={},this.cancels={},this.dest=e,this.timeoutMs=r,this.dest.onmessage=e=>a(this,[e],void 0,(function*({data:e}){const r=e;if("cancel"===r.type){const e=this.cancels[r.id];delete this.cancels[r.id],null==e||e.abort()}else if("response"===r.type){const e=this.callbacks[r.id];delete this.callbacks[r.id],e&&e(r.error?new Error(r.error):void 0,r.response,r.timings)}else if("request"===r.type){const e=new dt("worker"),i=t[r.name],n=new AbortController,s=i.apply(i,[...r.args,n,e]),o=`${r.name}_${r.id}`;if(r.id&&s){this.cancels[r.id]=n;try{const t=yield s,i=null==t?void 0:t.transferrables;this.postMessage({id:r.id,type:"response",response:t,timings:e.finish(o)},i)}catch(t){this.postMessage({id:r.id,type:"response",error:(null==t?void 0:t.toString())||"error",timings:e.finish(o)})}delete this.cancels[r.id]}}}))}postMessage(e,t){this.dest.postMessage(e,t||[])}send(e,t,r,i,...n){const s=++ft,o=new Promise(((r,o)=>{this.postMessage({id:s,type:"request",name:e,args:n},t),this.callbacks[s]=(e,t,n)=>{null==i||i.addAll(n),e?o(e):r(t)}}));return p(r,(()=>{delete this.callbacks[s],this.postMessage({id:s,type:"cancel"})})),function(e,t,r){let i=()=>{};const n=setTimeout((()=>{i(new Error("timed out")),null==r||r.abort()}),e);p(r,(()=>{i(new Error("aborted")),clearTimeout(n)}));const s=new Promise(((e,t)=>{i=t}));return Promise.race([s,t.finally((()=>clearTimeout(n)))])}(this.timeoutMs,o,r)}},e.C=we,e.H=Le,e.L=class{constructor(e,t,r,i,n){this.pmtiles=null,this.loaded=Promise.resolve(),this.decodeImage=Ne,this.fetchAndParseTile=(e,t,r,i,n)=>{const s=this,o=`${e}/${t}/${r}`;return null==n||n.useTile(o),this.parsedCache.get(o,((i,o)=>a(this,void 0,void 0,(function*(){const i=yield s.fetchTile(e,t,r,o,n);if(g(o))throw new Error("canceled");const a=s.decodeImage(i.data,s.encoding,o),l=null==n?void 0:n.marker("decode"),h=yield a;return null==l||l(),h}))),i)},this.tileCache=new m(t),this.parsedCache=new m(t),this.contourCache=new m(t),this.timeoutMs=n,this.fileUrl=e,this.encoding=r,this.maxzoom=i,this.pmtiles=null}initializePMTiles(){return a(this,void 0,void 0,(function*(){this.pmtiles=function(e){const t=new we(e);return new Ce(t)}(this.fileUrl)}))}fetchTile(e,t,r,i,n){return a(this,void 0,void 0,(function*(){if(!this.pmtiles)throw new Error("pmtiles is not initialized.");const s=`${e}/${t}/${r}`;return null==n||n.useTile(s),new Promise(((o,l)=>a(this,void 0,void 0,(function*(){if(i.signal.aborted)return void l(new Error("Request aborted by parent."));const h=new AbortController;i.signal.addEventListener("abort",(()=>{h.abort()}));try{null==n||n.fetchTile(s);const i=null==n?void 0:n.marker("fetch");if(this.pmtiles){const n=yield function(e,t,r,i){return a(this,void 0,void 0,(function*(){try{const n=yield e.getZxy(t,r,i);return n&&n.data?{data:n.data}:{data:void 0}}catch(e){return console.error("Error fetching tile:",e),{data:void 0}}}))}(this.pmtiles,e,t,r);if(null==i||i(),n&&n.data){const e=new Blob([n.data]);o({data:e,expires:void 0,cacheControl:void 0})}else l(new Error(`Tile data not found for z:${e} x:${t} y:${r}`))}else l(new Error("pmtiles is not initialized."))}catch(i){l(new Error(`Failed to fetch DEM tile for z:${e} x:${t} y:${r} from PMTiles: ${i}`))}finally{h.abort()}}))))}))}fetchDem(e,t,r,i,n,s){return a(this,void 0,void 0,(function*(){const o=Math.min(e-(i.overzoom||0),this.maxzoom),a=e-o,l=1<<a,h=Math.floor(t/l),c=Math.floor(r/l),d=yield this.fetchAndParseTile(o,h,c,n,s);return Le.fromRawDem(d).split(a,t%l,r%l)}))}fetchContourTile(e,t,r,i,n,o){const{levels:l,multiplier:h=1,buffer:d=1,extent:u=4096,contourLayer:f="contours",elevationKey:p="ele",levelKey:w="level",subsampleBelow:m=100}=i;if(!l||0===l.length)return Promise.resolve({arrayBuffer:new ArrayBuffer(0)});const y=[e,t,r,c(i)].join("/");return this.contourCache.get(y,((n,c)=>a(this,void 0,void 0,(function*(){const n=1<<e,a=[];for(let s=r-1;s<=r+1;s++)for(let r=t-1;r<=t+1;r++)a.push(s<0||s>=n?void 0:this.fetchDem(e,(r+n)%n,s,i,c,o));const y=yield Promise.all(a);let v=Le.combineNeighbors(y);if(!v||g(c))return{arrayBuffer:(new Uint8Array).buffer};const b=null==o?void 0:o.marker("isoline");if(v.width>=m)v=v.materialize(2);else for(;v.width<m;)v=v.subsamplePixelCenters(2).materialize(2);v=v.averagePixelCentersToGrid().scaleElevation(h).materialize(1);const x=s(l[0],v,u,d);null==b||b();const T=function(e){const t=new $e;for(const r in e.layers){const i=e.layers[r];i.extent||(i.extent=e.extent),t.writeMessage(3,Xe,Object.assign(Object.assign({},i),{id:r}))}return t.finish()}({extent:u,layers:{[f]:{features:Object.entries(x).map((([e,t])=>{const r=Number(e);return{type:Qe.LINESTRING,geometry:t,properties:{[p]:r,[w]:Math.max(...l.map(((e,t)=>r%e==0?t:0)))}}}))}}});return null==b||b(),{arrayBuffer:T.buffer}}))),n)}},e.T=dt,e._=a,e.a=function(e){return Object.fromEntries(e.replace(/^.*\?/,"").split("&").map((e=>{const t=e.split("=").map(decodeURIComponent),r=t[0];let i=t[1];switch(r){case"thresholds":n=i,i=Object.fromEntries(n.split("~").map((e=>e.split("*").map(Number))).map((([e,...t])=>[e,t])));break;case"extent":case"multiplier":case"overzoom":case"buffer":i=Number(i)}var n;return[r,i]})))},e.b=s,e.c=De,e.d=Ne,e.e=function(e){var{thresholds:t}=e,r=o(e,["thresholds"]);return l(Object.assign({thresholds:h(t)},r)).map((([e,t])=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&")},e.f=function(e){return e.then((({arrayBuffer:e})=>{const t=function(e){const t=new ArrayBuffer(e.byteLength);return new Uint8Array(t).set(new Uint8Array(e)),t}(e);return{arrayBuffer:t,transferrables:[t]}}))},e.g=function(e,t){const{thresholds:r}=e,i=o(e,["thresholds"]);let n=[],s=-1/0;return Object.entries(r).forEach((([e,r])=>{const i=Number(e);i<=t&&i>s&&(s=i,n="number"==typeof r?[r]:r)})),Object.assign({levels:n},i)},e.p=function(e,t){return e.then((e=>{var{data:r}=e,i=o(e,["data"]);let n=r;return t&&(n=new Float32Array(r.length),n.set(r)),Object.assign(Object.assign({},i),{data:n,transferrables:[n.buffer]})}))},e.x=Ce})),i(0,(function(e){const t=e=>Promise.reject(new Error(`No manager registered for ${e}`));const r="undefined"!=typeof self?self:"undefined"!=typeof window?window:global;r.actor=new e.A(r,new class{constructor(){this.managers={},this.init=(t,r)=>(this.managers[t.managerId]=new e.L(t.fileUrl,t.cacheSize,t.encoding,t.maxzoom,t.timeoutMs),this.managers[t.managerId].initializePMTiles(),Promise.resolve()),this.fetchTile=(e,r,i,n,s,o)=>{var a;return(null===(a=this.managers[e])||void 0===a?void 0:a.fetchTile(r,i,n,s,o))||t(e)},this.fetchAndParseTile=(r,i,n,s,o,a)=>{var l;return e.p((null===(l=this.managers[r])||void 0===l?void 0:l.fetchAndParseTile(i,n,s,o,a))||t(r),!0)},this.fetchContourTile=(r,i,n,s,o,a,l)=>{var h;return e.f((null===(h=this.managers[r])||void 0===h?void 0:h.fetchContourTile(i,n,s,o,a,l))||t(r))}}})})),i(0,(function(e){const t={workerUrl:""};let r,i=0;class n{constructor(){this.decodeImage=(t,r,i)=>e.p(e.d(t,r,i),!1)}}function s(){if(!r){const i=new Worker(t.workerUrl),s=new n;r=new e.A(i,s)}return r}class o{constructor(e,t,r,n,o,a){this.pmtiles=null,this.fetchTile=(e,t,r,i,n)=>this.actor.send("fetchTile",[],i,n,this.managerId,e,t,r),this.fetchAndParseTile=(e,t,r,i,n)=>this.actor.send("fetchAndParseTile",[],i,n,this.managerId,e,t,r),this.fetchContourTile=(e,t,r,i,n,s)=>this.actor.send("fetchContourTile",[],n,s,this.managerId,e,t,r,i);const l=this.managerId=++i;this.pmtiles=null,this.fileUrl=e,this.actor=a||s(),this.loaded=this.actor.send("init",[],new AbortController,void 0,{cacheSize:t,fileUrl:e,encoding:r,maxzoom:n,managerId:l,timeoutMs:o})}initializePMTiles(){return e._(this,void 0,void 0,(function*(){const t=new e.C(this.fileUrl);this.pmtiles=new e.x(t)}))}}Blob.prototype.arrayBuffer||(Blob.prototype.arrayBuffer=function(){return new Promise(((e,t)=>{const r=new FileReader;r.onload=t=>{var r;return e(null===(r=t.target)||void 0===r?void 0:r.result)},r.onerror=t,r.readAsArrayBuffer(this)}))});const a=e=>(t,r)=>{if(r instanceof AbortController)return e(t,r);{const i=new AbortController;return e(t,i).then((e=>r(void 0,e.data,e.cacheControl,e.expires)),(e=>r(e))).catch((e=>r(e))),{cancel:()=>i.abort()}}},l=new Set;const h={generateIsolines:e.b,DemSource:class{constructor({url:t,cacheSize:r=100,id:i="dem",encoding:n="terrarium",maxzoom:s=12,worker:h=!0,timeoutMs:c=1e4,actor:d}){this.timingCallbacks=[],this.onTiming=e=>{this.timingCallbacks.push(e)},this.setupMaplibre=e=>{e.addProtocol(this.sharedDemProtocolId,this.sharedDemProtocol),e.addProtocol(this.contourProtocolId,this.contourProtocol)},this.sharedDemProtocolV4=(t,r)=>e._(this,void 0,void 0,(function*(){const[i,n,s]=this.parseUrl(t.url),o=new e.T("main");let a;try{const e=yield this.manager.fetchTile(i,n,s,r,o);a=o.finish(t.url);return{data:yield e.data.arrayBuffer(),cacheControl:e.cacheControl,expires:e.expires}}catch(e){throw a=o.error(t.url),e}finally{this.timingCallbacks.forEach((e=>e(a)))}})),this.contourProtocolV4=(t,r)=>e._(this,void 0,void 0,(function*(){const i=new e.T("main");let n;try{const[s,o,a]=this.parseUrl(t.url),l=e.a(t.url),h=yield this.manager.fetchContourTile(s,o,a,e.g(l,s),r,i);return n=i.finish(t.url),{data:h.arrayBuffer}}catch(e){throw n=i.error(t.url),e}finally{this.timingCallbacks.forEach((e=>e(n)))}})),this.contourProtocol=a(this.contourProtocolV4),this.sharedDemProtocol=a(this.sharedDemProtocolV4),this.contourProtocolUrl=t=>`${this.contourProtocolUrlBase}?${e.e(t)}`;let u=i,f=1;for(;l.has(u);)u=i+f++;l.add(u),this.sharedDemProtocolId=`${u}-shared`,this.contourProtocolId=`${u}-contour`,this.sharedDemProtocolUrl=`${this.sharedDemProtocolId}://{z}/{x}/{y}`,this.contourProtocolUrlBase=`${this.contourProtocolId}://{z}/{x}/{y}`;const p=h?o:e.L;this.manager=new p(t,r,n,s,c,d),this.manager.initializePMTiles()}getDemTile(e,t,r,i){return this.manager.fetchAndParseTile(e,t,r,i||new AbortController)}parseUrl(e){const[,t,r,i]=/\/\/(\d+)\/(\d+)\/(\d+)/.exec(e)||[];return[Number(t),Number(r),Number(i)]}},HeightTile:e.H,LocalDemManager:e.L,decodeParsedImage:e.c,set workerUrl(e){t.workerUrl=e},get workerUrl(){return t.workerUrl}};return h})),r}));
